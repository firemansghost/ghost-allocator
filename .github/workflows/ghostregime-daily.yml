name: GhostRegime Daily Refresh

on:
  schedule:
    - cron: "30 3 * * 1-5"  # 3:30 AM UTC, Monday-Friday (after US market close)
  workflow_dispatch: {}  # Allow manual trigger

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Force refresh GhostRegime (persist latest)
        env:
          URL: https://ghost-allocator.vercel.app/api/ghostregime/today?force=1
          CRON_SECRET: ${{ secrets.GHOSTREGIME_CRON_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "$CRON_SECRET" ]; then
            echo "❌ GHOSTREGIME_CRON_SECRET not set in GitHub Actions secrets"
            exit 1
          fi
          RESP="$(curl -sS --fail --retry 3 --retry-delay 5 -H "x-ghostregime-cron: ${CRON_SECRET}" "${URL}&cb=$(date +%s)")"
          echo "$RESP"

          python3 - <<PY
          import json
          import sys
          
          data = json.loads("""$RESP""")

          if "error" in data:
              print(f"❌ API error: {data['error']} - {data.get('message','')}")
              sys.exit(1)

          if data.get("stale") is True:
              print(f"❌ Stale=true: {data.get('stale_reason','(no reason)')}")
              sys.exit(1)

          print(f"✅ OK - Date: {data.get('date')}, Regime: {data.get('regime')}, Source: {data.get('data_source')}")
          PY

      - name: Check GhostRegime health
        env:
          HEALTH_URL: https://ghost-allocator.vercel.app/api/ghostregime/health
        run: |
          set -euo pipefail
          HEALTH_RESP="$(curl -sS --fail --retry 2 --retry-delay 3 "${HEALTH_URL}?cb=$(date +%s)")"
          echo "$HEALTH_RESP"

          python3 - <<PY
          import json
          import sys
          
          health = json.loads("""$HEALTH_RESP""")

          if not health.get("ok"):
              print(f"❌ Health check failed: {health.get('status')} - {health.get('message','')}")
              sys.exit(1)

          freshness = health.get("freshness", {})
          warnings = health.get("warnings", [])
          
          if health.get("status") == "OK":
              print(f"✅ Health OK - Latest: {freshness.get('latest_date')}, Age: {freshness.get('age_days')} days")
          else:
              print(f"⚠️  Health WARN - Latest: {freshness.get('latest_date')}, Age: {freshness.get('age_days')} days (max: {freshness.get('max_age_days')}), Status: {health.get('status')}")
              if warnings:
                  for warning in warnings:
                      print(f"   ⚠️  {warning}")
              # Don't fail on WARN (weekends/holidays are expected)
          PY

